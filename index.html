<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Sidebar Position - Animated Hamburger (Improved)</title>
    <style>
        /* Your existing CSS code from the prompt */
        :root {
            --primary-color: #2c3e50; /* Darker blue */
            --primary-hover: #34495e; /* Slightly darker blue for hover */
            
            --secondary-color: #e67e22; /* Vibrant orange */
            --secondary-hover: #d35400; /* Darker orange */
            
            --neutral-color: #ecf0f1; /* Light gray */
            
            --background-light: #f4f6f7; /* Very light gray background */
            --background-white: #ffffff;
            
            --text-dark: #212529;
            --text-light: #ffffff;
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: var(--background-light);
            color: var(--text-dark);
            overflow-x: hidden;
            transition: margin-left 0.4s ease;
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap');

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-color);
            color: var(--text-light);
            padding: 15px 25px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        header .logo {
            font-size: 1.6rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        header .logout-btn {
            background: var(--secondary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            color: var(--text-light);
            font-weight: 500;
            transition: background 0.3s, transform 0.2s;
        }

        header .logout-btn:hover {
            background: var(--secondary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Hamburger */
        .hamburger {
            display: none;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
            width: 30px;
            height: 21px;
            position: relative;
            z-index: 1001;
            transition: transform 0.3s;
        }

        .hamburger span {
            display: block;
            height: 3px;
            width: 100%;
            background: var(--text-light);
            border-radius: 2px;
            transition: all 0.3s ease-in-out;
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(1) {
            transform: translateY(9px) rotate(45deg);
        }

        .hamburger.active span:nth-child(3) {
            transform: translateY(-9px) rotate(-45deg);
        }

        /* Sidebar (Desktop) */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background: var(--background-white);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding-top: 80px;
            z-index: 999;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 18px 25px;
            text-decoration: none;
            color: var(--text-dark);
            transition: background 0.3s, color 0.3s;
            font-weight: 500;
            position: relative;
        }

        .sidebar ul li a:hover {
            background: var(--background-light);
            color: var(--primary-color);
        }

        .sidebar ul li a.active {
            background: var(--primary-color);
            color: var(--text-light);
        }
        
        .sidebar ul li a.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background: var(--secondary-color);
        }

        /* Content (Desktop) */
        .content {
            margin-left: 250px;
            padding: 100px 30px 30px;
            transition: margin-left 0.4s ease;
        }
        
        /* Mobile overrides */
        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }
            
            header .logout-btn {
                display: none; /* Hide logout button on mobile for a cleaner look */
            }

            .header-actions {
                display: none; /* Hide desktop actions on mobile */
            }
            
            .sidebar {
                left: unset;
                right: -250px;
                box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            }
            
            .sidebar.active {
                right: 0;
                transform: translateX(0);
            }
            
            .content {
                margin-left: 0;
                padding: 100px 20px 20px;
            }
        }


        /* CSS from previous response - Combined for product page */
        .main-container { padding: 0; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-header h2 { margin: 0; }
        .save-db-btn, .add-product-btn { 
            padding: 10px 20px; 
            background-color: var(--primary-color); 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: 500;
            transition: background 0.3s, transform 0.2s;
        }
        .save-db-btn:hover, .add-product-btn:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .save-db-btn { display: none; background-color: #28a745; }
        .save-db-btn:hover { background-color: #218838; }

        /* NEW: Filter Styles */
        .filters-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filters-container input,
        .filters-container select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.9rem;
            font-family: 'Poppins', sans-serif;
        }
        .filters-container input[type="search"] {
            flex-grow: 1;
            min-width: 250px;
        }
        .filters-container select {
            min-width: 200px;
        }


        /* Table styles */
        .table-container { overflow-x: auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; color: #333; }
        .action-cell { white-space: nowrap; }
        .edit-btn { background: none; border: none; cursor: pointer; color: var(--secondary-color); font-size: 1.2em; transition: color 0.3s; }
        .edit-btn:hover { color: var(--secondary-hover); }

        .no-stock {
            opacity: 0.5;
        }

        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
        .modal-header h3 { margin-top: 0; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal-body input, .modal-body textarea, .modal-body select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .modal-body .required label:after { content: "*"; color: red; margin-left: 5px; }
        .modal-footer { text-align: right; border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px; }
        .save-modal-btn { padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; }
        .save-modal-btn:hover { background-color: var(--primary-hover); }

        /* Responsive styles */
        @media screen and (max-width: 1024px) {
            .modal-content { width: 80%; margin: 3% auto; }
        }
        @media screen and (max-width: 768px) {
            .page-header { flex-direction: column; align-items: flex-start; }
            .save-db-btn, .add-product-btn { margin-top: 10px; }
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border: 1px solid #ccc; margin-bottom: 10px; }
            td { border: none; position: relative; padding-left: 50%; text-align: right; }
            td:before { content: attr(data-label); position: absolute; left: 0; width: 50%; padding-left: 15px; font-weight: bold; text-align: left; }
        }
        @media screen and (max-width: 476px) {
            .main-container { padding: 10px; }
            .modal-content { padding: 15px; }
            .modal-footer { text-align: center; }
        }
        @media screen and (max-width: 360px) {
            .page-header h2 { font-size: 1.2em; }
            .save-db-btn, .save-modal-btn, .add-product-btn { font-size: 0.9em; padding: 8px 15px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Company Logo</div>
        <div class="header-actions">
            <button class="logout-btn">Logout</button>
        </div>
        <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </header>

    <div class="sidebar" id="sidebar">
        <ul>
            <li><a href="index.html" class="active">🏠 Products</a></li>
            <li><a href="new_estimation.html">📝 New Estimation</a></li>
            <li><a href="old_estimation.html">🧾 Old Estimations</a></li>
            <li><a href="mark_estimation.html">Marked Estimation</a></li>
            <li><a href="enquiry.html">📞 Enquiry</a></li>
        </ul>
    </div>

    <div class="content">
        <div class="main-container">
            <div class="page-header">
                <h2>Products List</h2>
                <div>
                    <button id="addProductBtn" class="add-product-btn">Add Product</button>
                    <button id="saveToDbBtn" class="save-db-btn">Save to DB</button>
                </div>
            </div>

            <div class="filters-container">
                <input type="search" id="searchBox" placeholder="Search by Product Name or ID...">
                <select id="categoryFilter">
                    <option value="">All Categories</option>
                </select>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Product ID</th>
                            <th>Name</th>
                            <th>Offer Price</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="modal-header">
                <h3 id="modalTitle">Edit Product</h3>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="form-group required">
                        <label for="productName">Product Name</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label for="productTamilName">Product Tamil Name</label>
                        <input type="text" id="productTamilName">
                    </div>
                    <div class="form-group required">
                        <label for="originalPrice">Original Price</label>
                        <input type="number" id="originalPrice" step="1" required>
                    </div>
                    <div class="form-group">
                        <label for="offerPrice">Offer Price</label>
                        <input type="number" id="offerPrice" step="1">
                    </div>
                    <div class="form-group">
                        <label for="categoryInput">Category</label>
                        <input list="categoriesDatalist" id="categoryInput">
                        <datalist id="categoriesDatalist"></datalist>
                    </div>
                    <div class="form-group">
                        <label for="inStock">In Stock</label>
                        <select id="inStock">
                            <option value="1">No Stock</option>
                            <option value="0">In Stock</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="content">Content</label>
                        <textarea id="content" rows="1"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="image">Image URL</label>
                        <input type="text" id="image">
                    </div>
                    <div class="form-group">
                        <label for="video">Video URL (YouTube)</label>
                        <input type="text" id="video">
                    </div>
                    <div class="form-group">
                        <label for="instagram">Instagram URL</label>
                        <input type="text" id="instagram">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="saveModalBtn" class="save-modal-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Basic UI Elements ---
            const hamburger = document.getElementById('hamburger');
            const sidebar = document.getElementById('sidebar');
            const navLinks = document.querySelectorAll('.sidebar ul li a');
    
            function toggleSidebar() {
                sidebar.classList.toggle('active');
                hamburger.classList.toggle('active');
            }
    
            hamburger.addEventListener('click', toggleSidebar);
    
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    if (window.innerWidth <= 768) {
                        toggleSidebar();
                    }
                });
            });
    
            // --- Product Management Scripts ---
            const productsTableBody = document.getElementById('productsTableBody');
            const productModal = document.getElementById('productModal');
            const saveModalBtn = document.getElementById('saveModalBtn');
            const saveToDbBtn = document.getElementById('saveToDbBtn');
            const addProductBtn = document.getElementById('addProductBtn');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('productForm');

            // --- NEW: Filter Elements ---
            const searchBox = document.getElementById('searchBox');
            const categoryFilter = document.getElementById('categoryFilter');

            let allProducts = [];
            let editedProducts = {};
    
            const fetchProducts = async () => {
                try {
                    const response = await fetch('fetch_products.php', { method: 'POST' });
                    allProducts = await response.json();
                    localStorage.setItem('products', JSON.stringify(allProducts));
                    
                    populateCategoryFilter(); // NEW: Populate dropdown
                    applyFiltersAndRender(); // NEW: Render based on filters
                } catch (error) {
                    console.error('Error fetching products:', error);
                    allProducts = JSON.parse(localStorage.getItem('products')) || [];

                    populateCategoryFilter(); // NEW: Populate dropdown from local data
                    applyFiltersAndRender(); // NEW: Render based on filters from local data
                }
            };
    
            // --- NEW: Filter Functions ---
            const populateCategoryFilter = () => {
                const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))]; // Get unique, non-empty categories
                categoryFilter.innerHTML = '<option value="">All Categories</option>'; // Reset
                categories.sort().forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categoryFilter.appendChild(option);
                });
            };

            const applyFiltersAndRender = () => {
                const searchTerm = searchBox.value.toLowerCase();
                const selectedCategory = categoryFilter.value;

                let filteredProducts = allProducts.filter(product => {
                    const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                                          product.product_id.toLowerCase().includes(searchTerm);
                    const matchesCategory = !selectedCategory || product.category === selectedCategory;

                    return matchesSearch && matchesCategory;
                });

                renderProducts(filteredProducts);
            };


            const renderProducts = (productsToRender) => { // Modified to accept an array
                productsTableBody.innerHTML = '';
                productsToRender.forEach(product => {
                    const row = document.createElement('tr');
                    if (product.in_stock === "1" || product.in_stock === 1) {
                        row.classList.add('no-stock');
                    }
                    row.innerHTML = `
                        <td data-label="Product ID">${product.product_id}</td>
                        <td data-label="Name">${product.name}</td>
                        <td data-label="Offer Price">₹${product.offer_price}</td>
                        <td data-label="Action" class="action-cell">
                            <button class="edit-btn" data-id="${product.product_id}">✏️</button>
                        </td>
                    `;
                    productsTableBody.appendChild(row);
                });
    
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const productId = e.currentTarget.getAttribute('data-id');
                        const product = allProducts.find(p => p.product_id === productId);
                        openModal(product);
                    });
                });
            };
    
            const openModal = (product) => {
                modalTitle.textContent = product ? 'Edit Product' : 'Add New Product';
                form.reset();
                if (product) {
                    document.getElementById('productId').value = product.product_id;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productTamilName').value = product.tamil_name || document.getElementById('productName').value;
                    document.getElementById('originalPrice').value = product.original_price;
                    document.getElementById('offerPrice').value = product.offer_price || document.getElementById('originalPrice').value;
                    document.getElementById('categoryInput').value = product.category || 'New';
                    document.getElementById('inStock').value = product.in_stock;
                    document.getElementById('content').value = product.content || '1PKT';
                    document.getElementById('image').value = product.image || 'image.jpg';
                    document.getElementById('video').value = product.video || 'https://www.youtube.com/';
                    document.getElementById('instagram').value = product.instagram || 'https://www.instagram.com/';
                } else {
                    document.getElementById('productId').value = '';
                    document.getElementById('inStock').value = '0'; // Default to "In Stock"
                }
    
                const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))];
                const datalist = document.getElementById('categoriesDatalist');
                datalist.innerHTML = '';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    datalist.appendChild(option);
                });
                
                productModal.style.display = 'block';
            };
    
            const closeModal = () => {
                productModal.style.display = 'none';
            };


            function getNextProductId(products) {
    let maxNum = 0;

    products.forEach(p => {
        // product_id la irunthu number part eduthu
        const num = parseInt(p.product_id.replace(/\D/g, ''), 10); 
        if (num > maxNum) {
            maxNum = num;
        }
    });

    // Max number vida 1 increase pannura
    const nextNum = maxNum + 1;
    return "P" + String(nextNum).padStart(3, '0'); // Example: P006
}
    
            const saveChanges = () => {
                const productId = document.getElementById('productId').value;
                const name = document.getElementById('productName').value;
    
                if (!name) { 
                    alert('Product Name is required.'); 
                    return; 
                }
                const originalPrice = document.getElementById('originalPrice').value;
                if (!originalPrice) {
                    alert('Original Price is required.');
                    return;
                }
                
                const tamilName = document.getElementById('productTamilName').value || document.getElementById('productName').value;
                const offerPrice = document.getElementById('offerPrice').value || document.getElementById('originalPrice').value;
                const category = document.getElementById('categoryInput').value || 'New';
                const inStock = document.getElementById('inStock').value;
                const content = document.getElementById('content').value || '1PKT';
                const image = document.getElementById('image').value || 'image.jpg';
                const video = document.getElementById('video').value || 'https://www.youtube.com/';
                const instagram = document.getElementById('instagram').value || 'https://www.instagram.com/';
                
                const lastUpdated = new Date().toISOString().slice(0, 19).replace('T', ' ');
    
                let updatedProduct = {
                    product_id: productId,
                    name,
                    tamil_name: tamilName,
                    original_price: parseFloat(originalPrice),
                    offer_price: parseFloat(offerPrice),
                    category,
                    in_stock: parseInt(inStock, 10),
                    content,
                    image,
                    video,
                    instagram,
                    last_updated: lastUpdated
                };
                
                let isNewProduct = !productId;
    
                if (isNewProduct) {
                const newId = getNextProductId(allProducts);
    updatedProduct.product_id = newId;
    allProducts.push(updatedProduct);
}
    
                localStorage.setItem('products', JSON.stringify(allProducts));
                editedProducts[updatedProduct.product_id] = { ...updatedProduct, action: isNewProduct ? 'add' : 'update' };
                
                saveToDbBtn.style.display = 'block';
                
                populateCategoryFilter(); // Repopulate in case a new category was added
                applyFiltersAndRender();
                closeModal();
            };
    
            const saveToDatabase = async () => {
                const productsToSave = Object.values(editedProducts);
                for (const product of productsToSave) {
                    try {
                        const response = await fetch('save_products.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(product)
                        });
                        const result = await response.json();
                        console.log(result.message);
                    } catch (error) {
                        console.error('Error saving product to DB:', error);
                    }
                }
                editedProducts = {};
                saveToDbBtn.style.display = 'none';
                alert('All changes saved to database!');
                fetchProducts();
            };
    
            // --- Event Listeners ---
            document.querySelector('.close-btn').addEventListener('click', closeModal);
            window.addEventListener('click', (e) => {
                if (e.target === productModal) {
                    closeModal();
                }
            });
            saveModalBtn.addEventListener('click', saveChanges);
            saveToDbBtn.addEventListener('click', saveToDatabase);
            addProductBtn.addEventListener('click', () => openModal(null));
            
            // --- NEW: Filter Event Listeners ---
            searchBox.addEventListener('input', applyFiltersAndRender);
            categoryFilter.addEventListener('change', applyFiltersAndRender);

            // --- Initial Fetch ---
            fetchProducts();
        });
    </script>
</body>
</html>